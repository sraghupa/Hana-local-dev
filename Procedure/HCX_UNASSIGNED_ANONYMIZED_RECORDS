CREATE PROCEDURE CDIS_CORE.HCX_UNASSIGNED_ANONYMIZED_RECORDS(IN p_JOB_ID VARCHAR(255))
LANGUAGE SQLSCRIPT
AS
BEGIN

--drop table #S_NON_HCX ;
--drop table #HCX_OUT;
--drop table #HCX_OUT_DEDUP;

CREATE LOCAL TEMPORARY TABLE #S_NON_HCX 
(GR_ID DECIMAL(34) NOT NULL,
 PRIMARY KEY(GR_ID));

INSERT INTO #S_NON_HCX  
SELECT DISTINCT
GR_ID 
 FROM S_HCX_PROCESSOR_HCXCON HC 
 INNER JOIN UDM_ACC_CON CON                             
    ON HC.GR_ID = CON.ID
 WHERE CON.IS_TO_BE_FORGOTTEN = 'Y' --and ( NAME_1 like '%Anonymized Record%' or 
--first_name like '%Anonymized Record%'  or last_name like '%Anonymized Record%') 
   and GR_ID IS NOT NULL;

CREATE LOCAL TEMPORARY TABLE #HCX_OUT
(
  GR_ID      DECIMAL(34) NOT NULL,
  ATTRIBUTE  NVARCHAR(50),
  "VALUE"    NVARCHAR(255)
);

INSERT INTO #HCX_OUT (GR_ID, ATTRIBUTE, "VALUE")
SELECT
    A.GR_ID,
    'HCX-TYPE' AS ATTRIBUTE,
    'NON-HCX'  AS "VALUE"
FROM #S_NON_HCX AS A

UNION ALL

SELECT
    A.GR_ID,
    'HCX-SCORE' AS ATTRIBUTE,
    '1'         AS "VALUE"
FROM #S_NON_HCX AS A

UNION ALL

SELECT
    A.GR_ID,
    'HCX-INFOCODE' AS ATTRIBUTE,
    '3' || TO_VARCHAR(C."VALUE") AS "VALUE"
FROM #S_NON_HCX AS A
LEFT JOIN UDM_CDIS_GROUP AS C
    ON C.GR_ID = A.GR_ID;
   
CREATE LOCAL TEMPORARY TABLE #HCX_OUT_DEDUP
(
  GR_ID      DECIMAL(34) NOT NULL,
  ATTRIBUTE  NVARCHAR(50),
  "VALUE"    NVARCHAR(255)
);

INSERT INTO #HCX_OUT_DEDUP (GR_ID, ATTRIBUTE, "VALUE")
SELECT
  GR_ID,
  ATTRIBUTE,
  MAX("VALUE") AS "VALUE"
FROM #HCX_OUT
GROUP BY GR_ID, ATTRIBUTE;

UPSERT UDM_CDIS_GROUP (GR_ID, ATTRIBUTE, "VALUE", MODIFIED_BY,MODIFIED_AT)
SELECT
  O.GR_ID,
  O.ATTRIBUTE,
  O."VALUE",
 'HCX_ANONYMIZED'  AS MODIFIED_BY,
  p_JOB_ID AS MODIFIED_AT
--CURRENT_TIMESTAMP 
  FROM #HCX_OUT_DEDUP AS O;



INSERT INTO DT_HCX_PROCESSOR_SCOPE_ADJUSTMENT(
SELECT GR_ID FROM #S_NON_HCX  );


END;