CREATE PROCEDURE CDIS2_DPV_PM4_HCX_HISTORY(IN p_JobID NVARCHAR(255))	
LANGUAGE SQLSCRIPT
AS
BEGIN 

--UPSERT INTO DPV_PM4_HISTORY
MERGE INTO "CDIS_CORE"."DPV_PM4_HISTORY"  H
USING"CDIS_CORE"."S_DPV_PM4_GR_ACC_CON_ID"  A
ON H.SOURCE_SYSTEM = A.SOURCE_SYSTEM
AND H.SOURCE_SYSTEM_LK=A.SOURCE_SYSTEM_LK
WHEN MATCHED 
AND A.STATUS='Y'
AND A.SENT='N'
AND H.HCX_TYPE <> A.HCX_TYPE THEN
UPDATE SET
 H.HCX_TYPE = A.HCX_TYPE,
 H.JOB_ID = p_JobID
 WHEN NOT MATCHED 
 AND A.SENT='Y'
 THEN 
 INSERT(
 GR_ID,
 ACC_CON_ID,
 SOURCE_SYSTEM,
 SOURCE_SYSTEM_LK,
 HCX_TYPE,
 JOB_ID
)
VALUES(A.GR_ID,
A.ACC_CON_ID,
A.SOURCE_SYSTEM,
A.SOURCE_SYSTEM_LK,
A.HCX_TYPE,
 p_JobID);
 
END;